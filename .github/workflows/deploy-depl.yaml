name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      IMAGE_REGISTRY: docker.io
      IMAGE_REPOSITORY: elishevafefer

    steps:
    # Checkout the code
    - name: Checkout Code
      uses: actions/checkout@v4

    # Log in to Docker Hub
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # Build and Push Docker Images for each service
    - name: Build and Push Bitcoin Service Image
      run: |
        docker build -t $IMAGE_REGISTRY/$IMAGE_REPOSITORY/bitcoinservice:latest ./BitcoinService
        docker push $IMAGE_REGISTRY/$IMAGE_REPOSITORY/bitcoinservice:latest

    - name: Build and Push Worker Service Image
      run: |
        docker build -t $IMAGE_REGISTRY/$IMAGE_REPOSITORY/someworkerservice:latest ./SomeWorkerService
        docker push $IMAGE_REGISTRY/$IMAGE_REPOSITORY/someworkerservice:latest

  # Set up Minikube
    - name: start minikube
        id: minikube
        uses: medyagh/setup-minikube@latest

    - name: kubectl
        run: kubectl get pods -A

    - name: Apply Kubernetes files
      run: |
        kubectl apply -f K8S/ # Apply your Kubernetes deployment files

    # # Verify the application is running
    # - name: Check if the services are running
    #   run: |
    #     kubectl get pods
    #     kubectl get services

